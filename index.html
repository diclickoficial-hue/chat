<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Chat WebRTC Auto (GitHub Gist)</title>
<style>
  body { font-family:sans-serif; margin:20px; }
  #chat { border:1px solid #ccc; padding:10px; height:200px; overflow-y:auto; }
  #message { width:80%; }
  button { margin-top:5px; }
</style>
</head>
<body>
<h2>Chat WebRTC Auto (GitHub)</h2>
<div id="chat"></div>
<input id="message" placeholder="Escribe un mensaje..." />
<button id="sendBtn">Enviar</button>

<script>
const chat = document.getElementById('chat');
const msgInput = document.getElementById('message');
const sendBtn = document.getElementById('sendBtn');

function log(msg){
  chat.innerHTML += msg + '<br>';
  chat.scrollTop = chat.scrollHeight;
}

let pc = new RTCPeerConnection();
let dataChannel = pc.createDataChannel("chat");
dataChannel.onmessage = e => log("<b>Otro:</b> " + e.data);

sendBtn.onclick = ()=>{
  let text = msgInput.value.trim();
  if(text && dataChannel.readyState==="open"){
    dataChannel.send(text);
    log("<b>Tú:</b> "+text);
    msgInput.value="";
  }
};

// --- GIST setup ---
const GIST_ID = "TU_GIST_ID_AQUI"; // reemplaza con tu Gist ID
const FILE_NAME = "signal.json";

async function getSignal(){
  const res = await fetch(`https://api.github.com/gists/${GIST_ID}`);
  const data = await res.json();
  return JSON.parse(data.files[FILE_NAME].content);
}

async function updateSignal(signal){
  await fetch(`https://api.github.com/gists/${GIST_ID}`,{
    method:"PATCH",
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({files:{[FILE_NAME]:{content:JSON.stringify(signal)}}})
  });
}

// --- WebRTC ---
pc.onicecandidate = e=>{
  if(e.candidate===null){
    updateSignal({offer: pc.localDescription, answer: ""});
  }
};

async function init(){
  let signal = await getSignal();

  if(!signal.offer || signal.offer===""){
    // Creamos la oferta
    let offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    log("Oferta creada, esperando conexión...");
  } else if(signal.offer && !signal.answer){
    // Aplicamos la oferta y creamos respuesta
    await pc.setRemoteDescription(signal.offer);
    let answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    updateSignal({offer: signal.offer, answer: pc.localDescription});
    log("Respuesta enviada!");
  } else if(signal.offer && signal.answer){
    await pc.setRemoteDescription(signal.answer);
    log("Conexión establecida!");
  }
}

pc.ondatachannel = event=>{
  dataChannel = event.channel;
  dataChannel.onmessage = e=>log("<b>Otro:</b> " + e.data);
  log("Canal recibido!");
};

init();
</script>
</body>
</html>
