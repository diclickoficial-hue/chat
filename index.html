<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Chat WebRTC Simple</title>
<style>
  body { font-family: sans-serif; margin: 20px; }
  #chat { border:1px solid #ccc; padding:10px; height:200px; overflow-y:auto; }
  #message { width:80%; }
  textarea { width:100%; height:80px; }
  button { margin-top:5px; }
</style>
</head>
<body>
<h2>Chat WebRTC Simple</h2>

<div id="chat"></div>
<input id="message" placeholder="Escribe un mensaje..."/>
<button id="sendBtn">Enviar</button>

<hr>
<h3>Señalización manual</h3>
<p>Copiar y pegar los textos para conectarse:</p>
<textarea id="signalIn" placeholder="Pega la señal aquí..."></textarea>
<button id="applySignal">Aplicar señal</button>
<textarea id="signalOut" placeholder="Señal para enviar al otro..." readonly></textarea>

<script>
let pc = new RTCPeerConnection();
let dataChannel = pc.createDataChannel("chat");

const chat = document.getElementById('chat');
const msgInput = document.getElementById('message');
const sendBtn = document.getElementById('sendBtn');
const signalIn = document.getElementById('signalIn');
const signalOut = document.getElementById('signalOut');
const applySignal = document.getElementById('applySignal');

function log(msg) {
  chat.innerHTML += msg + '<br>';
  chat.scrollTop = chat.scrollHeight;
}

// Enviar mensaje
sendBtn.onclick = () => {
  let text = msgInput.value.trim();
  if(text && dataChannel.readyState === "open") {
    dataChannel.send(text);
    log("<b>Tú:</b> " + text);
    msgInput.value = "";
  }
};

// Recibir mensaje
dataChannel.onmessage = e => log("<b>Otro:</b> " + e.data);

// Generar oferta al cargar
pc.onicecandidate = e => {
  if(e.candidate === null) {
    signalOut.value = JSON.stringify(pc.localDescription);
  }
};

async function createOffer() {
  let offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  log("Oferta generada, copiar texto para el otro PC.");
}
createOffer();

// Aplicar señal entrante
applySignal.onclick = async () => {
  let signal = signalIn.value.trim();
  if(!signal) return alert("Pega la señal primero.");
  let desc = JSON.parse(signal);
  await pc.setRemoteDescription(desc);
  if(desc.type === "offer") {
    let answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    signalOut.value = JSON.stringify(pc.localDescription);
    log("Respuesta generada, copiar al otro PC.");
  } else {
    log("Conexión establecida!");
  }
};

// Reconectar si el otro crea un canal
pc.ondatachannel = event => {
  dataChannel = event.channel;
  dataChannel.onmessage = e => log("<b>Otro:</b> " + e.data);
  log("Canal de datos recibido!");
};
</script>
</body>
</html>
